###  CSRF漏洞

**简介**
跨站请求伪造（也称为 CSRF）是一种 Web 安全漏洞，允许攻击者诱导用户执行他们不打算执行的操
作。它允许攻击者部分规避同源策略，该策略旨在防止不同网站相互干扰。

其中Web 甲为存在CSRF漏洞的网站，Web 乙为攻击者构建的恶意网站，User 丙为Web A网站的合法用户。
**CSRF攻击攻击原理**及过程如下：
1.用户 丙 打开浏览器，访问受信任网站 甲 ，输入用户名和密码请求登录网站 甲；
2.在用户信息用过验证后，网站 甲 产生Cookie信息并返回给浏览器，此时用户登录网站 甲 成功，可以正常发送
请求到网站 甲；
3.用户未退出网站 甲 之前，在同一浏览器中打开一个TAB页访问网站 乙；
4.网站 乙 接受到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点 甲；
5.浏览器在接收到这些攻击性代码后，根据网站 乙 的请求，在用户不知情的情况下携带Cookie信息，向网站 甲 发出请求。网站 甲 并不知道该请求其实是由 乙 发起的，所以会根据用户 丙 的Cookie信息以 丙 的权限处理该请求，
导致来自网站 乙 的恶意代码被执行。

**要使 CSRF 攻击成为可能，必须具备三个关键条件：**

1一个功能操作。应用程序中存在攻击者有可能诱导用户的操作。这可能是特权操作（例如修改其他
用户的权限）或对用户特定数据的任何操作（例如更改用户自己的密码）。

2基于 Cookie 的会话处理。执行该操作涉及发出一个或多个 HTTP 请求，并且应用程序仅依赖会话
cookie 来识别发出请求的用户。没有其他机制可用于跟踪会话或验证用户请求。

3没有不可预测的请求参数。执行该操作的请求不包含攻击者无法确定或猜测其值的任何参数。例
如，当导致用户更改密码时，如果攻击者需要知道现有密码的值，则该功能不会受到攻击。

如果受害者用户访问攻击者的网页，将会发生以下情况：
攻击者的页面将触发对易受攻击的网站的 HTTP 请求。
如果用户登录到易受攻击的网站，他们的浏览器将自动在请求中包含他们的会话 cookie（假设未
使用SameSite cookie）。
易受攻击的网站将以正常方式处理请求，将其视为由受害者用户发出，并更改其电子邮件地址。

**防御CSRF漏洞**
防御 CSRF 攻击的最可靠方法是在相关请求中包含CSRF Token：
对于一般的会话令牌，是不可预测的
绑定到用户的会话
在执行相关操作之前，在每种情况下都经过严格验证

1验证 HTTP Referer 字段
（1）拿到referer
（2）分割出referer中的域名
（3）根据后缀匹配域名是否是可信域
2在请求地址中添加 token 并验证
3在 HTTP 头中自定义属性并验证

**参考**

https://zhuanlan.zhihu.com/p/398601816
https://juejin.cn/post/7031060650801496101
https://www.cnblogs.com/54chensongxia/p/11693666.html